---
# override/additions to docker-compose.yml for deploying to a docker swarm
# $ docker stack deploy -c docker-compose.yml -c docker-compose.prod.yml -c docker-stack.yml STACK_NAME
# better to use make deploy-stack
# labels used by constraints:
# - mmapp
# - mmdb
# - riffapi
# - web
# Labeling suggestion w/ 2 nodes in swarm:
#   node 1: mmapp web
#   node 2: mmdb riffapi web
version: '3.6'
services:
  riff-mm:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.labels.mmapp == true]

  riff-server:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.labels.riffapi == true]

  mongo-server:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.labels.riffapi == true]

  mm-mysql:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.labels.mmdb == true]

  signalmaster:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
    configs:
      - source: signalmaster.local-production.yml.1
        target: /app/config/local-production.yml

  web-server:
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.labels.web == true]

volumes:
  registry-data:

configs:
  riff-rtc.local-production.yml.7.debug:
    external: true
  signalmaster.local-production.yml.1:
    external: true
