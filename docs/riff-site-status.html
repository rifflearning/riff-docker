<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <script src="https://cdn.jsdelivr.net/npm/ky@latest/umd.js"></script>
        <!-- script src="https://d3js.org/d3.v6.min.js"></script -->
        <script src="https://cdn.jsdelivr.net/npm/d3-selection@2"></script>
        <style>
            table.site-status
            {
            }

            tr.up
            {
                color:            black;
                background-color: chartreuse;
            }

            tr.down
            {
                color:            white;
                background-color: red;
            }
        </style>
    </head>
    <body>
        <script>
            const eduSites = [
                'ccob-wpu',
                'cliffcollege',
                'dev',              // not expected to be always up
                'esme-learning',
                'gv-mit',
                'jordan',           // not expected to be always up
                'newcollege',
                'questrom-bu',
                'said-oxford',
                'sgu',
                'staging',
            ];

            const remoteSites = [
                'asb-my',
                'boldly-app',
                'callcoach',
                'clarovc',
                'digital-leaders',
                'esme',
                'hackforthepeople',
                'knowfully',
                'learningseeds',
                'learnlaunch',
                'manpower',
                'mfs',
                'mikecardus',
                'my',
                'riffai',
                'roiinstitute',
                'surfx',
                'swedishdoulas',
                'teamwpoff',
                'ude-vet',
                'ventureuniversity',
                'webhose',
                'wiwin-homeschooling',
            ];

            class SiteStatus {
                constructor({ group, sites }) {
                    this._siteGroup = group;
                    this._siteStatuses = {};
                    this._parent = null;

                    sites.forEach(site => this.updateStatus({ site }));
                }

                render(parentSelector) {
                    this._parent = d3.select(parentSelector);

                    const thead = this._parent.append('thead');
                    const theadRow = thead.append('tr');
                    theadRow.append('th').text('Site Name');
                    theadRow.append('th').text('Status');
                    theadRow.append('th').text('Last checked');

                    const tbody = this._parent.append('tbody');
                    this.update();
                }

                update() {
                    if (this._parent === null) {
                        return;
                    }

                    const sites = Object.keys(this._siteStatuses).sort();
                    const siteStatuses = sites.map(site => this._siteStatuses[site]);

                    const tbody = this._parent.select('tbody');
                    const siteRows = tbody.selectAll('tr').data(siteStatuses);
                    siteRows.exit().remove();
                    const siteRowsEnter = siteRows.enter().append('tr');
                    siteRowsEnter.append('td').text(d => d.site);
                    siteRowsEnter.append('td').text(d => d.status);
                    siteRowsEnter.append('td').text(d => d.lastUpdate);

                    siteRows
                        .classed('up', d => d.status === 'up')
                        .classed('down', d => d.status === 'down');
                }

                updateStatus({ site, response }) {
                    if (!(site in this._siteStatuses)) {
                        this._siteStatuses[site] = {
                            site,
                            lastResponse: null,
                            status: 'down',
                            lastUpdate: new Date(),
                        };
                    }

                    const isSiteUp = Boolean(response);
                    this._siteStatuses[site].lastResponse = response;
                    this._siteStatuses[site].status = isSiteUp ? 'up' : 'down';;
                    this._siteStatuses[site].lastUpdate = new Date();

                    this.update();
                }

                static async healthcheck(site, group) {
                    const domain = `${site}.${group}.com`;
                    const healthcheckUrl = `https://${domain}/healthcheck`;
                    const resp = await ky(healthcheckUrl);
                    const contentType = resp.headers.get('content-type');
                    let parsedResp;
                    if (contentType === 'application/json') {
                        parsedResp = await resp.json();
                    }
                    else {
                        parsedResp = await resp.text();
                    }
                    return parsedResp;
                }
            }
        </script>

        <h1> Riff Analytics Site Status </h1>

        <h2> RiffEdu Sites </h2>
        <table class="riffedu site-status"></table>

        <h2> RiffRemote Sites </h2>
        <table class="riffremote site-status"></table>

        <script>
            const remoteSiteStatus = new SiteStatus({ group: 'riffremote', sites: remoteSites });
            remoteSiteStatus.render('table.site-status.riffremote');

            remoteSites.forEach(async (site) => {
                try {
                    const response = await SiteStatus.healthcheck(site, 'riffremote');
                    remoteSiteStatus.updateStatus({ site, response });
                    console.info({ site, response });
                }
                catch (err) {
                    remoteSiteStatus.updateStatus({ site });
                    console.warn({ site, err });
                }
            });


        </script>
    </body>
</html>
