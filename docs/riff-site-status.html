<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title> Riff Analytics Site Status </title>
        <script src="https://cdn.jsdelivr.net/npm/ky@latest/umd.js"></script>
        <!-- script src="https://d3js.org/d3.v6.min.js"></script -->
        <script src="https://cdn.jsdelivr.net/npm/d3-selection@2"></script>
        <style>
            table.site-status
            {
            }

            tr.up
            {
                color:            black;
                background-color: chartreuse;
            }

            tr.down
            {
                color:            white;
                background-color: red;
            }
        </style>
        <script>
            const eduSites = [
                'ccob-wpu',
                'cliffcollege',
                'demo',
                'dev',              // not expected to be always up
                'esme-learning',
                'gv-mit',
                'jordan',           // not expected to be always up
                'newcollege',
                'questrom-bu',
                'said-oxford',
                'sgu',
                'staging',
            ];

            const remoteSites = [
                'asb-my',
                'boldly-app',
                'callcoach',
                'clarovc',
                'digital-leaders',
                'esme',
                'hackforthepeople',
                'knowfully',
                'learningseeds',
                'learnlaunch',
                'manpower',
                'mfs',
                'mikecardus',
                'my',
                'nleadership',
                'riffai',
                'roiinstitute',
                'surfx',
                'swedishdoulas',
                'teamwpoff',
                'ude-vet',
                'ventureuniversity',
                'webhose',
                'wiwin-homeschooling',
            ];

            const platformSites = [
                'dev',
                'diagnostic',
                'emeritus',
                'grantthornton',
                'jordan',
                'mike',
                'said-oxford',
                'staging',
            ];

            class Logger {
                static logFn = {
                    noop() {}, // Noop function to use for disabled log levels
                    log: console.log.bind(window.console),
                    debug: null,
                    info: null,
                    warn: console.warn.bind(window.console),
                    error: console.error.bind(window.console),
                };

                constructor() {
                    /** enum debug, info, warn, error, none */
                    this._level = 'none';
                    this._disableLogging();
                }

                _disableLogging() {
                    this.debug = Logger.logFn.noop;
                    this.info = Logger.logFn.noop;
                    this.warn = Logger.logFn.noop;
                    this.eror = Logger.logFn.noop;
                }

                get level() {
                    return this._level;
                }

                set level(newLevel) {
                    this._level = newLevel;
                    this._disableLogging();

                    switch (this._level) {
                        case 'debug':
                            this.debug = Logger.logFn.debug;
                        case 'info':
                            this.info = Logger.logFn.info;
                        case 'warn':
                            this.warn = Logger.logFn.warn;
                        case 'error':
                            this.error = Logger.logFn.error;
                        case 'none':
                    }
                }
            }
            Logger.logFn.debug = console.debug?.bind(window.console) ?? Logger.logFn.log;
            Logger.logFn.info = console.info?.bind(window.console) ?? Logger.logFn.log;

            const logger = new Logger();
            logger.level = 'debug';

            class SiteStatus {
                constructor({ group, sites, title }) {
                    this._siteTitle = title;
                    this._siteGroup = group;
                    this._siteStatuses = {};
                    this._parent = null;
                    this._count = null;
                    this._tbody = null;

                    // bind checkSites to the instance so it can be used as a callback by setInterval
                    this.checkSites = this.checkSites.bind(this);

                    sites.forEach(site => this.updateStatus({ site }));
                }

                get title() {
                    return this._siteTitle;
                }

                get sites() {
                    return Object.keys(this._siteStatuses);
                }

                get group() {
                    return this._siteGroup;
                }

                render(parentSelector) {
                    this._parent = d3.select(parentSelector);

                    const header = this._parent.append('h2');
                    header.append('span').text(`${this.title} Sites (`);
                    const count = header.append('span')
                        .classed('count', true)
                        .text(0);
                    header.append('span').text(')');

                    const table = this._parent.append('table')
                        .classed('site-status', true);

                    const thead = table.append('thead');
                    const theadRow = thead.append('tr');
                    theadRow.append('th').text('Site Name');
                    theadRow.append('th').text('Status');
                    theadRow.append('th').text('Last checked');

                    const tbody = table.append('tbody');

                    this._count = count;
                    this._tbody = tbody;

                    this.update();
                }

                update() {
                    // No updating until rendered
                    if (this._parent === null) {
                        return;
                    }

                    const sites = this.sites.sort();
                    const siteStatuses = sites.map(site => this._siteStatuses[site]);

                    this._count.text(sites.length);

                    const siteRows = this._tbody.selectAll('tr').data(siteStatuses)
                        .join(enter => {
                            const rows = enter.append('tr')
                            rows.append('td').text(d => d.site);
                            rows.append('td').text(d => d.status);
                            rows.append('td').text(d => d.lastUpdate);
                            return rows;
                        });

                    siteRows
                        .classed('up', d => d.status === 'up')
                        .classed('down', d => d.status === 'down');
                    siteRows.selectAll('td')
                        .text((d, i) => d[['site', 'status', 'lastUpdate'][i]]);
                }

                updateStatus({ site, response }) {
                    if (!(site in this._siteStatuses)) {
                        this._siteStatuses[site] = {
                            site,
                            lastResponse: null,
                            status: 'down',
                            lastUpdate: new Date(),
                        };
                    }

                    const isSiteUp = Boolean(response);
                    this._siteStatuses[site].lastResponse = response;
                    this._siteStatuses[site].status = isSiteUp ? 'up' : 'down';;
                    this._siteStatuses[site].lastUpdate = new Date();

                    this.update();
                }

                async checkSites() {
                    this.sites.forEach(async (site) => {
                        try {
                            const response = await SiteStatus.healthcheck(site, this.group);
                            this.updateStatus({ site, response });
                            logger.debug({ site, response });
                        }
                        catch (err) {
                            this.updateStatus({ site });
                            logger.warn({ site, err });
                        }
                    });
                }

                static async healthcheck(site, group) {
                    const domain = `${site}.${group}.com`;
                    const healthcheckUrl = `https://${domain}/healthcheck`;
                    const resp = await ky(healthcheckUrl);
                    const contentType = resp.headers.get('content-type');
                    let parsedResp;
                    if (contentType === 'application/json') {
                        parsedResp = await resp.json();
                    }
                    else {
                        parsedResp = await resp.text();
                    }
                    return parsedResp;
                }
            }
        </script>
    </head>
    <body>
        <h1> Riff Analytics Site Status </h1>

        <div class="riffedu site-status"></div>
        <div class="riffremote site-status"></div>
        <div class="riffplatform site-status"></div>

        <script>
            logger.level = 'warn';

            const eduSiteStatus = new SiteStatus({ group: 'riffedu',
                                                   sites: eduSites,
                                                   title: 'RiffEdu' });
            eduSiteStatus.render('div.site-status.riffedu');
            eduSiteStatus.checkSites();

            const remoteSiteStatus = new SiteStatus({ group: 'riffremote',
                                                      sites: remoteSites,
                                                      title: 'RiffRemote' });
            remoteSiteStatus.render('div.site-status.riffremote');
            remoteSiteStatus.checkSites();

            const platformSiteStatus = new SiteStatus({ group: 'riffplatform',
                                                      sites: platformSites,
                                                      title: 'RiffPlatform' });
            platformSiteStatus.render('div.site-status.riffplatform');
            platformSiteStatus.checkSites();

            // Recheck the sites on a regular interval
            const recheckInterval = 30 * 1000; // 30 seconds
            const eduCheckTimerId = setInterval(eduSiteStatus.checkSites, recheckInterval);
            const remoteCheckTimerId = setInterval(remoteSiteStatus.checkSites, recheckInterval);
            const platformCheckTimerId = setInterval(platformSiteStatus.checkSites, recheckInterval);
        </script>
    </body>
</html>
